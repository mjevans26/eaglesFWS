---
title: "How Bayesian Priors Affect Predicted Eagle Take at Wind Farms"
author: "Michael Evans, Defenders of Wildlife"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_document:
    css: custom.css
    df_print: paged
    fig_caption: yes
    fig_width: 7
    highlight: tango
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r setup, include=FALSE}
library(dplyr)
library(plotly)
library(shiny)
library(shinydashboard)
library(stringr)
library(tidyr)
library(viridis)

load("data/data.RData")

tab <- select(Bay16,SITE, TURBINES, EFFORT, FLIGHT_MIN)

prior <- curve(dgamma(x, shape = mean(Bay16$FLIGHT_MIN),  
                      rate = mean(Bay16$EFFORT)),
               from = 0.5,
               to = 2)

collision <- curve(dbeta(x, shape1 = 9.38, shape2 = 3224.51), 
                   from = 0, 
                   to = 0.01)

act <- mean(Bay16$FLIGHT_MIN)/mean(Bay16$EFFORT)

```

# Introduction

The U.S. Fish and Wildlife Service (FWS) uses a bayesian framework to develop a statistical model predicting eagle collisions, and fatalities, at proposed wind energy sites.  The appeal of Bayesian modeling is the ability to incorporate prior information and uncertainty regarding parameter values into posterior estimates, ideally providing a better representation of reality.  However, as Bayesian methodology is still gaining widespread familiarity, there remains confusion over how this prior information functions. The purpose of this paper is to illustrate and quantify the effects of Bayesian priors used by FWS on the predicted outcomes of the eagle motality model, in terms of .  We use both empirical data from wind farms provided in Bay et al. (2016), as well as a simulated dataset to demonstrate these effects both in theory and in practice.

If permitted eagle take exceeds 1% of the estimated population size of either species within the LAP area, additional take is a concern.  If take exceeds 5% of the estimated population size within the LAP area, additional take is considered inadvisable.  We must fin that cummulative authorized take does not exceed 5%.

Permits are re-evaluated every 5 years.

### Survey Data

The data shown in Table 1 are the key values used as inputs for the eagle wind mortality model.  These were derived from an empirical dataset (Appendix A in [Bay et al. (2016)](http://www.pnas.org/content/113/13/3563.full?tab=ds)), which contains pre-construction eagle survey data from 26 wind energy sites.  Survey effort (hr*km3) was caculated as the survey area in km<sup>2</sup>, (coverted from hectares), multiplied by 0.2 km, times the reported observation time in hrs.  Eagle observations are the duration of time over which eagles are observed flying within survey areas.  

```{r p1, echo=FALSE, warning=FALSE, error=FALSE}
fluidPage(
  fluidRow(
    column(12,
      p(class = "caption",
        "Table 1. Data from Bay et al. (2016).  Effort was calculated as the product of survey area (km<sup>2</sup>) and observation time (hr), derived from Appendix A.")
    )
  ),
  fluidRow(
    div(
    column(12,
  DT::datatable(tab,
                    fillContainer = TRUE,
                    selection = list(mode = 'single', 
                                     #selected = which(Bay16$SITE == input$sites), 
                                     target = 'row'),
                    colnames = c("Site", "Turbines", "Survey Effort (hr*km2)",
                                 "Eagle Obs (min)"),
                  options = list(rownames = FALSE,
                                 pageLength = nrow(tab),
                                 dom = 'tip'
                                 )
                )%>%
  DT::formatRound("EFFORT", 2)
    ))
  )
)
```


Eagle flight time and survey effort are used to estimate eagle exposure at a given wind site.  Fatalities are calculated as the product of site-specific exposure, and prior rates of eagle collisions with turbines.  Finally, a site specific scaling factor is used to transforms these rates into an estimated number of eagle fatalities per year, based on the size of the wind farm. Figure 1 shows how the exposure measured at each site (green lines) is combined with prior distribution of exposure probabilities (purple), to produce a probability distribution of exposure used to predict eagle fatalities for a given site (yellow).

```{r p4, echo=FALSE, warning=FALSE, error=FALSE}

plotList <- function(x){
  a <- mean(Bay16$FLIGHT_MIN) + Bay16$FLIGHT_MIN[x]
  b <- mean(Bay16$EFFORT) + Bay16$EFFORT[x]
  act <- Bay16$FLIGHT_MIN[x]/Bay16$EFFORT[x]
  obs <- density(rgamma(10000, shape = a, rate = b))
  site <- cat(Bay16$SITE)

  plot_ly()%>%
      add_trace(x = ~c(act, act), y = ~c(0,max(c(prior$y,obs$y))),
                type = "scatter", mode = "lines",
                name = "Observed", line = list(color = vir_col(3)[2]),
                text = ~paste("Observed Activity<br>at site = ",
                              round(act,2),
                              sep = ""),
                hoverinfo = "text")%>%
      add_trace(x = prior$x, y = prior$y,
                type = "scatter", mode = "lines", fill = "tozeroy",
                name = "Prior", line = list(color = vir_col(3)[1]),
                text = ~paste("Prior Activity<br>estimate = ",
                              round(prior$x, 2),
                              sep = ""),
                hoverinfo = "text")%>%
      add_trace(x = ~obs$x, y = ~obs$y,
                type = "scatter", mode = "lines", fill = "tozeroy",
                name = "Combined", line = list(color = vir_col(3)[3]),
                text = ~paste("Combined Activity<br>estimate = ",
                              round(obs$x, 2),
                              sep = ""),
                hoverinfo = "text")%>%
      layout(title = site,
        showlegend = FALSE,
             xaxis = list(range = c(0,3))
             )
}


fluidPage(
  fluidRow(
    column(12,
           subplot(lapply(1:16, plotList), 
        nrows = 4, shareY = TRUE, titleY = FALSE, shareX =TRUE,titleX= FALSE)%>%
  layout(xaxis = list(title = "Eagle Activity (min/km<sup>3</sup>*hr)"),
         yaxis = list(title = "Probability Density")
         )
    )
  ),
  fluidRow(
    column(12,
      p(class = "caption",
        "Figure 1. Eagle exposure rates used to estimate predicted fatalities across
        wind farms.  A prior probability distribution (purple) is combined with site-specific
        survey data (green line) to estimate an exposure probability distribution for a
        proposed project.")
    )
  )
)
```

### Combining Prior Information with Survey Data

Survey effort, and the number of eagles observed at a site can affect how strongly prior exposure probabilities determine predicted fatalities.  The influence of eagle exposure priors on estimated eagle fatalities was less for wind energy projects that expended greater effort on pre-construction surveys.  This pattern is indicated by the sites with the most intensive surveys falling closest to a 1:1 relationship between the two estimates (Fig. 2).  The use of prior exposure information produced a higher estimate of eagle take at a majority of sites (Fig. 2) than would have been produced using site-survey data only. These instances are indicated by points above the 1:1 line in Figure 1. 

```{r p2, echo=FALSE, warning=FALSE, error=FALSE}
fluidPage(
  fluidRow(
    column(12,
           plot_ly(Bay16)%>%
             add_trace(y = ~MN_F, x = ~MN, type = "scatter", mode = "markers", 
                       size = ~(UQ_F-LQ_F),
                       marker = list(line = list(color = "black"),
                            sizemode = "diameter",
                            colorbar = list(y = 0.75, x = 0.85,
                                            title = "Survey Effort<br>hr*km<sup>3</sup>")
                            ),
              sizes = c(10,25), color = ~ EFFORT, name = "Estimated Eagle Fatalities",
                            text = ~paste("Effort =", round(EFFORT,2),
                                          "hr*km<sup>3</sup>",
                                          "<br>80% CI =", round(LQ_F, 2),"-",
                                          round(UQ_F,2)), 
              hoverinfo = "text")%>%
             add_trace(x = ~c(0, max(MN_F)), y = ~c(0, max(MN_F)), type = "scatter",
                       mode = "lines", name = "1:1 Line")%>%
             layout(hovermode = "closest", font = list(color = "black"),
                    yaxis = list(title = "Estimates using Priors"),
                    xaxis = list(title = "Estimates without Priors"),
                    legend = list(x = 0.6, y = 0.3, bordercolor = "black",
                                  borderwidth = 1)
                    )
    )
  ),
  fluidRow(
    column(12,
      p(class = "caption",
        "Figure 2. Relationships between estimated eagle fatalities produced incorporating prior information about eagle exposure at wind facilities, and those produced using only site-specific survey data.  Plotted values are the mean of the posterior distributions.  Marker size is proportional to the size of the 80% CI produced from the posterior distribution using exposure priors.")
    )
  )
)
```

<p style='font-size:small'>Source: [Bay et al. (2016)](http://www.pnas.org/content/113/13/3563.full?tab=ds)</p>

# Simulation Study

###Generating Data Based on FWS Requirements

To investigate the effects of prior information and survey effort on predicted take, we created a dataset representing a range of possible pre-construction survey values for plot area, time, and eagle observations.  We based these values on the minimum requirements provided by U.S. FWS for pre-construction monitoring.  FWS requires at least one cylindrical survey plot with radius > 800m and height > 200m, and that plots be surveyed for at least 12 hours per year, for two years.  Thus, the minimum values for survey area and time were `r min(area)` km<sup>3</sup>, and `r min(time)` hrs, respectively. 

### Greater Survey Effort Reduces Effect of Priors
For eagle activity rates < 1.5 min/survey effort, predicted fatlity rates are higher when estimated using priors than without (i.e. above the 1:1 line in Fig. 2).  The trend reverses when activity rates are > 1.5.  This threshold corresponds to the mean observed activity rate of the prior exposure distribution.  Thus, but the pattern will be consistent (underprediction below, overprediction above).  Figure 2 also illustrates that predicted fatalities estimated with and without priors are more similar when survey effort is greater (i.e., larger circles).

```{r sim1, echo=FALSE, warning = FALSE, error = FALSE}
fluidPage(
  fluidRow(
    column(12,

plot_ly(sim[!(sim$eagle_rate %in% c(0.02, 0.03, 0.04, 0.06, 0.07, 0.08, 0.09)),])%>%
  add_trace(x = ~MN, y = ~MN_F, type = "scatter", mode = "markers", size = ~b,
            marker = list(line = list(color = "black"),
                          sizemode = "diameter",
                          colorbar = list(y = 1, x = 0.1,
                                          title = "Eagle Activity<br>Rate")
            ),
            sizes = c(5,15), color = ~ eagle_rate, name = "Estimated Eagle Fatalities",
            text = ~paste("Effort =", round(b, 3), "hr*km<sup>3</sup>",
                          "<br>Eagles =", eagle_rate),
            hoverinfo = "text")%>%
  add_trace(x = ~c(0, max(MN_F)), y = ~c(0, max(MN_F)),
            type = "scatter", mode = "lines", name = "1:1 Line")%>%
#  add_trace(x = ~c(0.002, 0.006), y = ~c(0.004, 0.004),
#            type = "scatter", mode = "lines", name = "Mean")%>%
  layout(hovermode = "closest", font = list(color = "black"),
         xaxis = list(title = "Estimates without Priors"),
         yaxis = list(title = "Estimates using Priors"),
         legend = list(x = 0.6, y = 0.3, bordercolor = "black", borderwidth = 1)
         )

           )
  ),
  fluidRow(
    column(12,
      p(class = "caption",
        "Figure 2. Predicted eagle fatalities produced with and without prior information about eagle exposure at wind facilities, generated from simulated data.  Plotted values are the mean of the posterior distributions.  Marker size is proportional to the size of the posterior distribution 80% CI.")
    )
  )
)
```


Increased survey effort reduces the influence of prior exposure on posterior estimates, resulting in less discrepacy between predictions obtained using priors and those obtained using site survey data only.  The magnitude of the effect of effort on estimate discrepancy is contingent upon the observed rate of eagle activity. For a site with minimum rate (0.01), adding an additional survey hour per month Similarly, the size of 80% CI from posterior estimates decreases as survey efforts increase (Fig. 3), indicating less uncertainty around fatality predictions. FWS ues the 80th percentile to set the eagle take limit when permitting wind facilities.

```{r p3, echo=FALSE, warning=FALSE, error=FALSE, message = FALSE}
#sim$b2 <- sim$b^2
dev_max <- glm(data = sim, (MN_F - MN)~ b, subset = eagle_rate == max(eagle_rate), 
               family = gaussian(link = "inverse"))
dev_min <- glm(data = sim, (MN_F - MN)~ b, subset = eagle_rate == min(eagle_rate), 
               family = gaussian(link = "inverse"))
int <- glm(data = sim, (UQ_F-LQ_F)~ b * eagle_rate)


fluidPage(
  fluidRow(
    column(6,
  plot_ly(sim)%>%
  add_trace(x = ~ b, y = ~(U_F - U), type = "scatter", mode = "markers",
            color = ~ eagle_rate, marker = list(
              colorbar = list(title = "Eagle Activity<br>(min)", y = 0.5, x = 0.8)),
            text = ~paste("Effort =", round(b, 3), "hr*km<sup>3</sup>", "<br>Eagles =", a,
                          "minutes"),
            hoverinfo = 'text',
            showlegend = FALSE)%>%
    add_trace(x = ~c(10, 10), y = ~c(min(MN_F - MN), max(MN_F - MN)), type = "scatter",
                       mode = "lines", name = "FWS Minimum")%>%
  layout(hovermode = 'closest',
         font = list(color = 'black'),
         xaxis = list(title = "Survey Effort (hr*km<sup>3</sup>)"
         ),
         yaxis = list(title = "Standardized Deviance"),
         legend = list(x = 0.5, y = 0.9)
  )
    ),
  column(6,

plot_ly(sim[!(sim$eagle_rate %in% c(0.02, 0.03, 0.04, 0.06, 0.07, 0.08, 0.09)),])%>%
  add_trace(x = ~b, y = ~(UQ_F-LQ_F)/MN_F, type = "scatter", mode = "markers",
            color = ~ eagle_rate,
            marker = list(colorbar = list(colorbar = list(showscale = FALSE))
            ), showlegend = FALSE,
            text = ~paste("Effort =", round(b, 3), "<br>Eagles =", eagle_rate ,
            "hr*km<sup>3</sup>"),
            hoverinfo = 'text')%>%
#      add_trace(x = ~c(10, 10), y = ~c(min(UQ_F-LQ_F), max(UQ_F-LQ_F)),
#                type = "scatter",
#                mode = "lines", name = "FWS Minimum<br>Survey Effort",
#                showlegend = FALSE)%>%
  hide_colorbar()%>%
  layout(hovermode = 'closest',
         font = list(color = 'black'),
         xaxis = list(title = "Survey Effort (hr*km<sup>3</sup>)"
         ),
         yaxis = list(title = "Size of 80% CI")
  )

    )
  ),
  fluidRow(
    column(12,
      p(class = "caption",
        "Fig. 3. Effects of survey effort on a) difference between fatalities predicted with and without using prior information, and b) the size of the 80% CI around predicted fatalities across a range of potential eagle activity levels.")
    )
  )
)


```
<p style='font-size:small'><sup>*</sup>Per species budget calculated as total appropriations divided by the number of listed species.</p>

Survey effort is used to adjust the rate parameter of the gamma distribution used to define the eagle exposure prior.  Thus, increased survey effort leads to a narrower posterior distribution, and smaller 80% CI.  In practice, this makes sense, as we have greater confidence that the results of more intensive surveys are reflective of consistent patterns, rather than conditions during a limited number of instances.  

# Policy Implications

### Primary Takeaways
The primary findings are that .  Simulation data can be used by both FWS and wind energy developers to understand and anticipate how survey data and prior information may produce .

An important question is when do priors significantly overpredict (bad because of undue restrictions on developers) versus underpredict.

The results of our simulation study indicate that the effor expended during pre-construction surveys has a significant effect on reducing the influence of prior information on predicted eagle fatalities at a given site.

### Recommendations
We recommend thresholds based on...

# Methods

### Simulation

We simulated up to five plots (area = `r max(area)`) in increments of one, and up to  `r max(time)` hrs in increments of 12, and calculated survey effort for all combinations.  Finally, we used the maximum observed value for eagle flight time (min) from Bay et al. (2016) to generate a range of values from 0, incrementing by 50.  The final simulation data included all combinations of survey effort and observed eagle activity, producing 1050 values.   

```{r eval = FALSE}
flight <- seq(0, 1000, 50)
time <- seq(1, 10, 1)*12*2
area <- seq(0.402, 2.01, 0.402)
df <- expand.grid(TIME = time, AREA = area, a = flight)
sim <- plyr::mdply(df[, c(3,4)], estimates, niters = 10000)
```

We then predicted at each combination of survey effort and eagle observation values, and report the mean, and 80% quantiles of the posterior distributions.  To generate predictions, we used the updated FWS priors for collision rate (XXX), and a.  FWS service uses a scaling factor based on the size, and hours of operation of a wind farm, to translate these per km3 estimates into predicted annual number of eagle fatalities.

------

<br><br>

```{r footer, echo=FALSE, warning=FALSE, error=FALSE}
fluidPage(
  fluidRow(
    column(2),
    column(8, 
      div(
        HTML('<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"> <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a> <br /> This <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/InteractiveResource" rel="dct:type">work</span> by <a xmlns:cc="http://creativecommons.org/ns" href="http://defenders.org" property="cc:attributionName" rel="cc:attributionURL">Defenders of Wildlife</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>. <br />'),
                           style = "text-align: center"
      )
    ),
    column(2)
  )
)
```
