---
title: "How Bayesian Priors Affect Predicted Eagle Take at Wind Farms"
author: "Michael Evans, Defenders of Wildlife"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_document:
    css: custom.css
    df_print: paged
    fig_caption: yes
    fig_width: 7
    highlight: tango
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r setup, include=FALSE}
library(dplyr)
library(DT)
library(plotly)
library(shiny)
library(shinydashboard)
library(stringr)
library(tidyr)
library(viridis)

load("data/data.RData")

tab <- select(Bay16,SITE, TURBINES, EFFORT, FLIGHT_MIN)

```

# Introduction

The U.S. Fish and Wildlife Service (FWS) uses a bayesian framework to develop a statisticl model predicting eagle collisions, and fatalities, at proposed wind energy sites.  The appeal of Bayesian modeling is the ability to incorporate prior information and uncertainty regarding parameter values into posterior estimates, ideally a closer representation of reality.  However, as Bayesian methodology is less familiar , there remains confusion over how this prior information functions.  Additionally, .  The purpose of this paper is to illustrate and quantify the effects of prior on the predicted outcomes of the eagle motality model, in terms of .  We use both empirical data from Bay et al. (2016), as well as a simulated dataset to demonstrate these effects both in theory and in practice.

# Methods

### Empirical Data

We used an empirical dataset from Appendix A in Bay et al. (2016), presenting pre-construction eagle survey data from 26 wind energy sites.  We calculated survey effort as the survey area in km

```{r p1, echo=FALSE, warning=FALSE, error=FALSE}
fluidPage(
  fluidRow(
    column(12,
      p(class = "caption",
        "Table 1. Data from Bay et al. (2016).  Effort was calculated as the product of survey area (km) and observation time (hr), derived from Appendix A.")
    )
  ),
  fluidRow(
    column(12,
  DT::datatable(tab,
                    fillContainer = TRUE,
                    selection = list(mode = 'single', 
                                     #selected = which(Bay16$SITE == input$sites), 
                                     target = 'row'),
                    colnames = c("Site", "Turbines", "Survey Effort (hr*km2)",
                                 "Eagle Obs (min)"),
                  options = list(rownames = FALSE,
                                 pageLength = nrow(tab),
                                 dom = 'tip'
                                 )
                )%>%
  formatRound("EFFORT", 2)
    )
  )
)
```

<p style='font-size:small'>Source: [Gerber, LR (2016). PNAS 113(13): 3563-3566](http://www.pnas.org/content/113/13/3563.full?tab=ds)</p> 

The influence of eagle exposure priors on estimated eagle fatalities was less for wind energy projects that expended greater effort on pre-construction surveys.  This pattern is indicated by the sites with the most intensive surveys falling closest to a 1:1 relationship between the two estimates.  The use of prior exposure information produced a higher estimate of eagle take at a majority of sites (Fig. 1) than would have been produced using site-survey data only.  

```{r p2, echo=FALSE, warning=FALSE, error=FALSE}
fluidPage(
  fluidRow(
    column(12,
           plot_ly(Bay16)%>%
             add_trace(x = ~MN_F, y = ~MN, type = "scatter", mode = "markers", 
                       size = ~(UQ_F-LQ_F),
                       marker = list(line = list(color = "black"),
                            sizemode = "diameter",
                            colorbar = list(y = 0.75, x = 0.85,
                                            title = "Survey Effort")
                            ),
              sizes = c(10,25), color = ~ EFFORT, name = "Estimated Eagle Fatalities",
                            text = ~paste("Effort =", round(EFFORT,2),
                                          "hr*km<sup>3</sup>",
                                          "<br>80% CI =", round(LQ_F, 2),"-",
                                          round(UQ_F,2)), 
              hoverinfo = "text")%>%
             add_trace(x = ~c(0, max(MN_F)), y = ~c(0, max(MN_F)), type = "scatter",
                       mode = "lines", name = "1:1 Line")%>%
             layout(hovermode = "closest", font = list(color = "black"),
                    xaxis = list(title = "Estimates using Priors"),
                    yaxis = list(title = "Estimates without Priors"),
                    legend = list(x = 0.10, y = 0.95, bordercolor = "black",
                                  borderwidth = 1)
                    )
    )
  ),
  fluidRow(
    column(12,
      p(class = "caption",
        "Figure 1. Relationships between estimated eagle fatalities produced incorporating prior information about eagle exposure at wind facilities, and those produced using only site-specific survey data.  Plotted values are the mean of the posterior distributions.  Marker size is proportional to the size of the 80% CI produced from the posterior distribution using exposure priors.")
    )
  )
)
```

<p style='font-size:small'>Source: [FWS Expenditure Reports](https://www.fws.gov/Endangered/esa-library/index.html)</p>

### Simulation Study

To investigate the effects of prior information and survey effort on predicted take, we created a dataset representing a range of possible values for survey plot area, survey time, and eagle observations.  We based these values on the minimum requirements provides by U.S. FWS for pre-construction monitoring.  FWS requires at least one cylindrical survey plot with radius > 800m and height > 200m, and that plots be surveyed for at least 12 hours per year, for two years.  Thus, our minimum simulated values for survey area and time were `r min(area)` km3, and `r min(time)` hrs, respectively.  We increments of one survey plot, up to five plots (area = `r max(area)`), and  `r max(time)` hrs, and generated a range of survey efforts forom all combinations.  Finally, we used the maximum observed value for eagle flight time in minutes, to generate a range of values from 0, incrementing by 50.  The final simulation data included 1050   

```{r eval = FALSE}
flight <- seq(0, 1000, 50)
time <- seq(1, 10, 1)*12*2
area <- seq(0.402, 2.01, 0.402)
df <- expand.grid(TIME = time, AREA = area, a = flight)
```

We then predicted at each combination of survey effort and eagle observation values, and report the mean, and 80% quantiles of the posterior distributions.  To generate predictions, we used the updated FWS priors for collision rate (XXX), and a.  FWS service uses a scaling factor based on the size, and hours of operation of a wind farm, to translate these per km3 estimates into predicted annual number of eagle fatalities. 

# Results

### Greater Survey Effort Reduces Effect of Priors

Survey effort is used to adjust the rate parameter of the gamma distribution used to define the eagle exposure prior.  Thus, increased survey effort leads to a narrower posterior distribution, and smaller 80% CI.  In practice, this makes sense, as we have greater confidence that the results of more intensive surveys are reflective of consistent patterns, rather than conditions during a limited number of instances.   

```{r p3, echo=FALSE, warning=FALSE, error=FALSE}
fluidPage(
  fluidRow(
    column(6,
  plot_ly(sim)%>%
  add_trace(x = ~b, y = ~(MN_F-MN)/MN, type = "scatter", mode = "markers",
            marker = list(colorbar = list(title = "Eagle Obs<br>(min)")),
            color = ~ a,
            text = ~paste("Effort =", round(b, 3), "<br>Eagles =", a,
                          "hr*km<sup>3</sup>"),
            hoverinfo = 'text')%>%
  layout(hovermode = 'closest',
         font = list(color = 'black'),
         xaxis = list(title = "Survey Effort (hr*km<sup>3</sup>)"
         ),
         yaxis = list(title = "Standardized Deviance")
  )
    ),
  column(6,

plot_ly(sim)%>%
  add_trace(x = ~b, y = ~UQ_F-LQ_F, type = "scatter", mode = "markers",
            color = ~ a,
            marker = list(colorbar = list(title = "Eagle Obs<br>(min)")
            ),
            text = ~paste("Effort =", round(b, 3), "<br>Eagles =", a), "hr*km<sup>3</sup>",
            hoverinfo = 'text')%>%
  layout(hovermode = 'closest',
         font = list(color = 'black'),
         xaxis = list(title = "Survey Effort (hr*km<sup>3</sup>)"
         ),
         yaxis = list(title = "Size of 80% CI")
  )

    )
  ),
  fluidRow(
    column(12,
      p(class = "caption",
        "Fig. #. Use the dropdown button to see total annual appropriations.")
    )
  )
)
```
<p style='font-size:small'><sup>*</sup>Per species budget calculated as total appropriations divided by the number of listed species.</p>
<p style='font-size:small'>Source: [FWS Budget Justification](https://www.fws.gov/budget/)</p> 

# Discussion

### Federal Agencies Have Been Spending Less on Listed Species


# State Spending

### Most Spending for ESA Activities Comes From Federal Agencies

On average, states spend 26% as much as FWS, and 4% as much as other federal agencies. This pattern has persisted over time. The amount states spend is highly relevant to current discussions about their role in implementing the ESA.

```{r p4, echo=FALSE, warning=FALSE, error=FALSE}
fluidPage(
  fluidRow(
    column(12, "eat poop"
    )
  ),
  fluidRow(
    column(12,
      p(class = "caption",
        "Categories may be turned off/on by clicking on the legend entry.")
    )
  )
)
```

<p style='font-size:small'>Source: [FWS Expenditure Reports](https://www.fws.gov/Endangered/esa-library/index.html)</p>

<br><br>

------

<br><br>

```{r footer, echo=FALSE, warning=FALSE, error=FALSE}
fluidPage(
  fluidRow(
    column(2),
    column(8, 
      div(
        HTML('<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"> <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a> <br /> This <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/InteractiveResource" rel="dct:type">work</span> by <a xmlns:cc="http://creativecommons.org/ns" href="http://defenders.org" property="cc:attributionName" rel="cc:attributionURL">Defenders of Wildlife</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>. <br />'),
                           style = "text-align: center"
      )
    ),
    column(2)
  )
)
```
